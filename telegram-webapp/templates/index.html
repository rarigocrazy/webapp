<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web App - –í—ã–±–æ—Ä—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .user-choice { 
            border: 1px solid #e1e5e9;
            margin: 10px 0; 
            padding: 15px; 
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .user-choice:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .my-choice { 
            background-color: #e8f5e8;
            border-color: #4caf50;
        }
        .status { 
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
        }
        .connected { 
            background-color: #e8f5e8; 
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        .disconnected { 
            background-color: #ffebee; 
            color: #c62828;
            border: 1px solid #f44336;
        }
        .loading { 
            background-color: #fff3e0; 
            color: #ef6c00;
            border: 1px solid #ff9800;
        }
        h1, h2 { color: #333; }
        .number-display {
            font-size: 2em;
            font-weight: bold;
            color: #1976d2;
        }
        .username {
            font-weight: bold;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –í—ã–±–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h1>
        
        <div id="status" class="status loading">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
        
        <div id="my-choice">
            <h2>–í–∞—à –≤—ã–±–æ—Ä:</h2>
            <div id="my-choice-content">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <div id="all-choices">
            <h2>–í—Å–µ –≤—ã–±–æ—Ä—ã:</h2>
            <div id="choices-list">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <script>
        // –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');
        
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω)
        const socket = io();
        
        const statusDiv = document.getElementById('status');
        const myChoiceDiv = document.getElementById('my-choice-content');
        const choicesListDiv = document.getElementById('choices-list');

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ WebSocket —Å–æ–±—ã—Ç–∏–π
        socket.on('connect', function() {
            statusDiv.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É';
            statusDiv.className = 'status connected';
            console.log('WebSocket connected');
        });

        socket.on('disconnect', function() {
            statusDiv.textContent = '‚ùå –ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
            statusDiv.className = 'status disconnected';
            console.log('WebSocket disconnected');
        });

        socket.on('connect_error', function(error) {
            statusDiv.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message;
            statusDiv.className = 'status disconnected';
            console.log('Connection error:', error);
        });

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö
        socket.on('data_update', function(data) {
            console.log('Received data update:', data);
            displayAllChoices(data.choices);
        });

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö –≤—ã–±–æ—Ä–æ–≤
        function displayAllChoices(choices) {
            if (!choices || choices.length === 0) {
                choicesListDiv.innerHTML = '<p>–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ —Å–¥–µ–ª–∞–ª –≤—ã–±–æ—Ä</p>';
                return;
            }
            
            choicesListDiv.innerHTML = '';
            
            choices.forEach(choice => {
                const div = document.createElement('div');
                div.className = `user-choice ${choice.user_id == userId ? 'my-choice' : ''}`;
                div.innerHTML = `
                    <div>
                        <span class="username">@${choice.username || '–ê–Ω–æ–Ω–∏–º'}</span> 
                        (${choice.user_id})
                    </div>
                    <div class="number-display">${choice.number}</div>
                `;
                choicesListDiv.appendChild(div);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        fetch('/api/all_choices')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                displayAllChoices(data.choices);
            })
            .catch(error => {
                console.error('Error loading all choices:', error);
                choicesListDiv.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–µ–≥–æ –≤—ã–±–æ—Ä–∞
        if (userId) {
            fetch(`/api/user/${userId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('User not found');
                    }
                    return response.json();
                })
                .then(data => {
                    myChoiceDiv.innerHTML = `
                        <div class="user-choice my-choice">
                            <div>
                                <span class="username">@${data.username || '–ê–Ω–æ–Ω–∏–º'}</span>
                            </div>
                            <div class="number-display">${data.number}</div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error loading user ', error);
                    myChoiceDiv.innerHTML = '<p>–í—ã–±–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
                });
        } else {
            myChoiceDiv.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</p>';
        }
    </script>
</body>
</html>